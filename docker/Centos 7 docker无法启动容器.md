## Centos 7 docker无法启动容器iptables: No chain/target/match by that name

首先防火墙关闭

使用命令启动容器，通过8085端口访问没有问题

然后把容器stop掉

然后把防火墙打开

然后重新启动容器，报错

```bash
Error response from daemon: driver failed programming external connectivity on endpoint loving_hamilton (9dc7432799a69410dc312bf83181285d10b38eb0c2a91e6e1a840ffa3117e3e6):  (iptables failed: iptables --wait -t nat -A DOCKER -p tcp -d 0/0 --dport 8085 -j DNAT --to-destination 172.17.0.2:80 ! -i docker0: iptables: No chain/target/match by that name.
 (exit status 1))
Error: failed to start containers: 657
```



![nuget-docekr-1.png](https://wx1.sinaimg.cn/large/0072fULUgy1g9exqyl8qhj312p030mxb.jpg)

初步判定是因为两次启动容器的防火墙状态不一致（容器是在防火墙关闭的时候创建，第一次是在防火墙关闭的时候运行，第二次是在防火墙开启的时候运行）

然后把防火墙关闭

![nuget-docker-2.png](https://wx1.sinaimg.cn/large/0072fULUgy1g9exuk5ztpj30md05gjrt.jpg)

然后再启动容器,还是报之前的错误。

然后去网上搜原因，似乎是因为需要重新建立docker0网络



### 第二次测试（在防火墙启动的时候创建容器）

第二次在防火墙启动的时候，重启docker，创建启动容器

![nuget-docker-5.png](https://wx1.sinaimg.cn/large/0072fULUgy1g9eyovidg7j311m0bsdh1.jpg)

然后关闭防火墙再启动，报错。

![nuget-docker-3.png](https://wx1.sinaimg.cn/large/0072fULUgy1g9eyl3iyxsj312p0cf40o.jpg)

然后把防火墙打开再启动，成功。

![nuget-docker-4.png](https://wx1.sinaimg.cn/large/0072fULUgy1g9eymfjoptj30um0extau.jpg)

### 三. 问题

在启动firewalld之后，iptables被激活，此时没有docker chain，重启docker后被加入到iptable里面。修改iptables规则后，重启了iptables，但没有重启docker

```bash
iptables -L
```

可以通过重启docker服务来解决，重建docker0网络恢复

通过分析异常信息，发现是因为在进行原地址到目标地址转换的时候没有在docker主机的iptables规则中找到nat表规则，只有filter表规则。

在filter表上面增加nat表配置规则信息，需要说明的是docker容器的网段是172.17.0.0/16，另外需要注意filter表中也要有docker链的相关配置。

找到系统的`/etc/sysconfig/iptables` ，如果没有用以下命令保存一下,然后查看里边的内容

```bash
iptables-save > /etc/sysconfig/iptables  
cat /etc/sysconfig/iptables  
```

sudo vi /etc/sysconfig/iptables

```bash
# Generated by iptables-save v1.4.21 on Fri Nov 29 16:23:46 2019
*filter
:INPUT ACCEPT [303:19230]
:FORWARD ACCEPT [0:0]
:OUTPUT ACCEPT [243:70716]
:DOCKER - [0:0]
-A FORWARD -o docker0 -j DOCKER
-A FORWARD -o docker0 -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT
-A FORWARD -i docker0 ! -o docker0 -j ACCEPT
-A FORWARD -i docker0 -o docker0 -j ACCEPT
COMMIT
# Completed on Fri Nov 29 16:23:46 2019
# Generated by iptables-save v1.4.21 on Fri Nov 29 16:23:46 2019
*nat
:PREROUTING ACCEPT [51:2536]
:INPUT ACCEPT [51:2536]
:OUTPUT ACCEPT [76:9042]
:POSTROUTING ACCEPT [76:9042]
:DOCKER - [0:0]
-A PREROUTING -m addrtype --dst-type LOCAL -j DOCKER
-A OUTPUT ! -d 127.0.0.0/8 -m addrtype --dst-type LOCAL -j DOCKER
-A POSTROUTING -s 172.17.0.0/16 ! -o docker0 -j MASQUERADE
COMMIT
# Completed on Fri Nov 29 16:23:46 2019
```

```bash
systemctl restart iptables.service 
```

停掉容器 ，启动防火墙，启动容器，报错，重启iptables.service，再重启容器，成功

![nuget-docekr-6.png](https://wx1.sinaimg.cn/large/0072fULUgy1g9f1awgi2uj30m30dh108.jpg)

